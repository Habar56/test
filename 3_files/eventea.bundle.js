!function(){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){if(this instanceof e){var n=[null];n.push.apply(n,arguments);var r=Function.bind.apply(t,n);return new r}return t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}var n,r={},s={};var o,i={};var a,l={};var u,c={};var d,h={},p={};var v,f,g={};function y(){return f||(f=1,t=h,n=e&&e.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),r=e&&e.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)},Object.defineProperty(t,"__esModule",{value:!0}),r(function(){return d||(d=1,e=p,Object.defineProperty(e,"__esModule",{value:!0}),e.EventeaFeaturesBits=void 0,(t=e.EventeaFeaturesBits||(e.EventeaFeaturesBits={}))[t.DiagStats=1]="DiagStats"),p;var e,t}(),t),r(function(){return v||(v=1,e=g,Object.defineProperty(e,"__esModule",{value:!0}),e.sendDiagMessage=e.DiagMessageType=e.HandlerStatus=e.SentStatus=e.IncompleteReason=void 0,(t=e.IncompleteReason||(e.IncompleteReason={}))[t.MissedProject=0]="MissedProject",t[t.MissedRouting=1]="MissedRouting",t[t.MissedEvent=2]="MissedEvent",t[t.MissedRoutes=3]="MissedRoutes",(n=e.SentStatus||(e.SentStatus={}))[n.Routed=0]="Routed",n[n.IncompleteRouting=1]="IncompleteRouting",n[n.Deprecated=2]="Deprecated",n[n.Dead=3]="Dead",(r=e.HandlerStatus||(e.HandlerStatus={}))[r.Handled=0]="Handled",r[r.MissedHandler=1]="MissedHandler",r[r.HandlerErrored=2]="HandlerErrored",(s=e.DiagMessageType||(e.DiagMessageType={}))[s.SendStart=0]="SendStart",s[s.SentStats=1]="SentStats",e.sendDiagMessage=function(e){if("undefined"!=typeof window)try{const t=new CustomEvent("__evntx10t",{bubbles:!0,detail:e});document.dispatchEvent(t)}catch(e){}}),g;var e,t,n,r,s}(),t)),h;var t,n,r}var m,b,S={};var w,j=function(){if(b)return r;b=1,Object.defineProperty(r,"__esModule",{value:!0}),r.Eventea=void 0;const e=function(){if(n)return s;n=1,Object.defineProperty(s,"__esModule",{value:!0}),s.EventeaBeerClient=void 0;const e=64e3;return s.EventeaBeerClient=class{constructor(e){if(this.batch=[],this.timer=null,"undefined"==typeof window)throw new Error("Eventea beer client is not isomorphic package");{const{baseUrl:t,batching:n}=e;this._request=e=>fetch(`${t}${e.method}`,{...e,method:e.httpMethod,keepalive:null==n?void 0:n.batchingEnable}).then((e=>e.json())),this.batchingEnable=(null==n?void 0:n.batchingEnable)||!1,this.batchSize=(null==n?void 0:n.batchSize)||50,this.batchDelay=(null==n?void 0:n.batchDelay)||50,document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState&&this.sendRemainingBatch()}))}}event(e){const t=this.formatEvent(e);return this.batchingEnable?(this.batch.push(t),this.batchSize>this.batch.length?(1===this.batch.length&&(this.timer=setTimeout((()=>this.sendBatch()),this.batchDelay)),Promise.resolve()):this.sendBatch()):this.sendImmediately(t)}formatEvent(e){var t;return{project:e.project,event:e.event,payload:{...e.payload||{},appName:null===(t=e.handlersData)||void 0===t?void 0:t.appName}}}sendRequest(e){return this._request({method:"event",httpMethod:"POST",body:JSON.stringify(e),headers:{"content-type":"application/json"},credentials:"omit"}).catch((()=>{}))}sendImmediately(e){return this.sendRequest(e)}calculateBatchSize(e){const t=JSON.stringify(e);return new Blob([t]).size}splitBatch(t){const n=[];let r=[];if(this.calculateBatchSize(t)<=e)return[t];for(const s of t){if(this.calculateBatchSize([s])>e){this.sendRequest({project:"eventea",event:"keepAliveDataExceed",payload:{eventName:s.event}});continue}const t=[...r,s];this.calculateBatchSize(t)>e?(n.push(r),r=[s]):r=t}return r.length>0&&n.push(r),n}async sendBatch(){const e=this.splitBatch(this.batch);this.batch=[],this.timer&&(clearTimeout(this.timer),this.timer=null);for(const t of e)await this.sendRequest(t)}sendRemainingBatch(){this.batch.length>0&&this.sendBatch()}},s}(),t=function(){if(o)return i;o=1,Object.defineProperty(i,"__esModule",{value:!0}),i.EventeaQueueObserver=i.EventeaQueue=void 0;const e="undefined"!=typeof window?window:void 0;return i.EventeaQueue=class{constructor(t){var n,r;this.send=e=>{this.__addEventToStore(["send",e])},this.sendOnce=e=>(this.__addEventToStore(["sendOnce",e]),!0),this.data=e=>{this.__addEventToStore(["data",e])},this.errorHandlers=null==t?void 0:t.errorHandlers,e?!e._evnteq&&(e._evnteq=[]):null===(r=null===(n=this.errorHandlers)||void 0===n?void 0:n.handleQueueUsageAtServer)||void 0===r||r.call(n)}__addEventToStore(...t){(null==e?void 0:e._evnteq)&&e._evnteq.push(...t)}get getQueue(){var t;return Array.isArray(null==e?void 0:e._evnteq)?null==e?void 0:e._evnteq:null===(t=null==e?void 0:e._evnteq)||void 0===t?void 0:t.queue}},i.EventeaQueueObserver=class{constructor(t){var n,r;this.observerSuspended=!1,this.queue=[],this.errorHandlers=null==t?void 0:t.errorHandlers,e?(Array.isArray(e._evnteq)&&this.queue.push(...e._evnteq),e._evnteq=this):(this.observerSuspended=!0,null===(r=null===(n=this.errorHandlers)||void 0===n?void 0:n.handleQueueUsageAtServer)||void 0===r||r.call(n))}set watch(e){var t,n;this.observerSuspended?null===(n=null===(t=this.errorHandlers)||void 0===t?void 0:t.handleQueueUsageAtServer)||void 0===n||n.call(t):(this.watcher=e,this.push(...this.queue),this.queue=[])}push(...e){var t,n;if(this.watcher)try{this.watcher(e)}catch(e){const{message:r}=e;null===(n=null===(t=this.errorHandlers)||void 0===t?void 0:t.handleObserverWatcherErrors)||void 0===n||n.call(t,r)}else this.queue.push(...e)}},i}(),d=(a||(a=1,Object.defineProperty(l,"__esModule",{value:!0}),l.EventeaDataState=void 0,l.EventeaDataState=class{constructor(e){this.__state={},this.add=e=>{const{project:t,payload:n}=e;this.__state[t]={...this.__state[t],...n}},this.remove=(...e)=>{const[t,n]=e;return!!this.__state[t]&&(delete this.__state[t][n],!0)},this.get=(...e)=>{const[t,n]=e;if(this.__state[t])return this.__state[t][n]},(null==e?void 0:e.initData)&&e.initData&&(this.__state=e.initData)}get _getAll(){return this.__state}}),l),h=function(){if(u)return c;u=1,Object.defineProperty(c,"__esModule",{value:!0}),c.sendPostMessage=void 0;const e="undefined"!=typeof window?window:void 0;return c.sendPostMessage=({type:t,payload:n,config:r={}})=>{const{targetOrigin:s="*",payloadProperty:o}=r;e&&(e.top||e.opener||e.parent).postMessage(JSON.stringify({type:t,...o?{[o]:n}:n}),s)},c}(),p=y(),v=y(),f=function(){if(m)return S;function e(e,t){return("string"==typeof e||"number"==typeof e||"boolean"==typeof e)&&t.includes(e)}return m=1,Object.defineProperty(S,"__esModule",{value:!0}),S.filterPayloadByWhitelist=void 0,S.filterPayloadByWhitelist=function(t,n){const r={...t};for(const s in n)if(s in t&&s in n)for(const o in n[s])o in t&&e(t[o],n[s][o])||delete r[s];return r},S}();class g{constructor(n){if(this.defaultEventHandlers={...n.defaultEventHandlers},this.defaultDataHandlers={...n.defaultDataHandlers},"undefined"==typeof window||window.__evntfxb1ts||(window.__evntfxb1ts=v.EventeaFeaturesBits.DiagStats),this.defaultEventHandlers.postMessage=({event:e,config:t,payload:n})=>(0,h.sendPostMessage)({type:e,config:t,payload:n}),n.beerBaseUrl){const t=new e.EventeaBeerClient({baseUrl:n.beerBaseUrl,batching:n.batchingConfig});this.defaultEventHandlers["eventea-beer"]=e=>null==t?void 0:t.event(e)}this.routingClientLoader=n.routingClientLoader,this.projectConfigurationMap=n.projectConfigurationMap,this.errorHandlers=n.errorHandlers,this.handlersData=n.handlersData||{},this.onceSentEvents=n.onceSentEvents||new Map,this.handleAnyEvent=n.handleAnyEvent,this.eventeaDataState=new d.EventeaDataState({initData:n.data}),this.eventeaQueueObserver=new t.EventeaQueueObserver({errorHandlers:{handleQueueUsageAtServer:this.errorHandlers.handleQueueUsageAtServer,handleObserverWatcherErrors:this.errorHandlers.handleObserverWatcherErrors}}),this.eventeaQueueObserver.watch=e=>{e.forEach((e=>{var t,n,r,s;const[o,i]=e;try{switch(o){case"send":this.send(i);break;case"sendOnce":this.sendOnce(i);break;case"data":this.data(i);break;default:null===(n=(t=this.errorHandlers).handleUnknownMethodInQueue)||void 0===n||n.call(t,{requestType:o})}}catch(e){null===(s=(r=this.errorHandlers).handleErrorQueueEvent)||void 0===s||s.call(r,{requestType:o,requestData:i})}}))}}doSend(e){var t,n,r,s;const{project:o,event:i}=e,a=this.projectConfigurationMap[o];let l=e;const u=t=>(0,p.sendDiagMessage)({type:p.DiagMessageType.SentStats,event:e,stats:t});if(!a)return this.errorHandlers.handleMissedProject({event:i,project:o}),void u({status:p.SentStatus.IncompleteRouting,reason:p.IncompleteReason.MissedProject});const c=a.routing;if(!c)return this.errorHandlers.handleMissedRouting({project:o}),void u({status:p.SentStatus.IncompleteRouting,reason:p.IncompleteReason.MissedProject});const d=c.events;if(!d)return this.errorHandlers.handleMissedRouting({project:o}),void u({status:p.SentStatus.IncompleteRouting,reason:p.IncompleteReason.MissedRouting});const h=d[i];if(!h)return this.errorHandlers.handleMissedEvent({event:i,project:o}),void u({status:p.SentStatus.IncompleteRouting,reason:p.IncompleteReason.MissedEvent});if(l.payload&&"allowIfMatch"in h&&h.allowIfMatch&&(l.payload=(0,f.filterPayloadByWhitelist)(l.payload,h.allowIfMatch)),"fromData"in h&&h.fromData){const{fromData:e}=h,t={};Object.keys(e).forEach((n=>{const r=this.eventeaDataState.get(o,e[n]);r&&(t[n]=r)})),l={...l,payload:{...t,...l.payload}}}const v=this._getTracking();if("fromDataPool"in h&&h.fromDataPool&&v){const e={};for(const t of Object.keys(h.fromDataPool)){e[t]=v._prot.dataPool[h.fromDataPool[t]]}const t=v._prot.collectDataElements(e);l={...l,payload:{...t,...l.payload}}}let g=this.handlersData;if(c.statist&&(g={...g,statist:c.statist}),this.handleAnyEvent&&this.handleAnyEvent({...l,eventRouting:h,handlersData:g}),"isDeprecated"in h&&h.isDeprecated)return null===(n=(t=this.errorHandlers).handleDeprecatedEvent)||void 0===n||n.call(t,{event:i,project:o}),void u({status:p.SentStatus.Deprecated});if(!("routes"in h))return null===(s=(r=this.errorHandlers).handleMissedRoutes)||void 0===s||s.call(r,{event:i,project:o}),void u({status:p.SentStatus.IncompleteRouting,reason:p.IncompleteReason.MissedRoutes});const y=Object.getOwnPropertyNames(h.routes);if(0==y.length)u({status:p.SentStatus.Dead});else{const e={};y.forEach((t=>{var n;const r=(null===(n=a.eventHandlers)||void 0===n?void 0:n[t])||this.defaultEventHandlers[t];if(!r)return this.errorHandlers.handleMissedEventHandler({project:o,event:i,routeHandlerName:t}),void(e[t]={status:p.HandlerStatus.MissedHandler});const s=h.routes[t],u={...l,config:s,handlersData:g};try{r(u),e[t]={status:p.HandlerStatus.Handled}}catch(n){if(e[t]={status:p.HandlerStatus.HandlerErrored,error:n},!this.errorHandlers.handleEventHandlerError)throw n;this.errorHandlers.handleEventHandlerError(n,t,u)}})),u({status:p.SentStatus.Routed,routesStats:e})}}send(e){(0,p.sendDiagMessage)({type:p.DiagMessageType.SendStart,event:e});const{project:t}=e,n=this.projectConfigurationMap[t];(null==n?void 0:n.routing)||!this.routingClientLoader?this.doSend(e):this.restoreProjectConfiguration(t).catch((()=>{(0,p.sendDiagMessage)({type:p.DiagMessageType.SentStats,event:e,stats:{status:p.SentStatus.IncompleteRouting,reason:p.IncompleteReason.MissedProject}})})).then((()=>{this.doSend(e)}))}sendOnce(e,t=!0){const n=`${e.project}/${e.event}`;this.onceSentEvents.has(n)||this.onceSentEvents.set(n,new Set);const r=this.onceSentEvents.get(n);return!r.has(t)&&(this.send(e),r.add(t),!0)}doData(e){var t,n,r,s;const{project:o}=e,i=this.projectConfigurationMap[o];if(!i)return void(null===(n=(t=this.errorHandlers).handleMissedDataProject)||void 0===n||n.call(t,{project:o}));const{dataHandlers:a={}}=i,l={...this.defaultDataHandlers,...a};for(const t of Object.keys(l)){const n=l[t];"function"==typeof n?n(e):null===(s=(r=this.errorHandlers).handleMissedDataHandler)||void 0===s||s.call(r,{project:o,handlerName:t})}this.eventeaDataState.add(e)}data(e){const{project:t}=e,n=this.projectConfigurationMap[t];(null==n?void 0:n.routing)||!this.routingClientLoader?this.doData(e):this.restoreProjectConfiguration(t).finally((()=>{this.doData(e)}))}restoreProjectConfiguration(e){const t=this.projectConfigurationMap[e];return!(null==t?void 0:t.routing)&&this.routingClientLoader?this.routingClientLoader.getRouting(e).then((n=>{t?t.routing=n:this.projectConfigurationMap[e]={routing:n}}),(t=>{var n,r;throw t||null===(r=(n=this.errorHandlers).handleMissedClientRouting)||void 0===r||r.call(n,{project:e}),t})):Promise.resolve()}replicateWithData(e){const t={...this.eventeaDataState._getAll,...null==e?void 0:e.additionalDataState};return new g({errorHandlers:this.errorHandlers,handlersData:{...this.handlersData,...null==e?void 0:e.additionalHandlersData},projectConfigurationMap:this.projectConfigurationMap,onceSentEvents:this.onceSentEvents,defaultEventHandlers:this.defaultEventHandlers,defaultDataHandlers:this.defaultDataHandlers,data:t})}_getTracking(){if("undefined"!=typeof window&&window.tracking&&tracking._prot)return window.tracking}}return r.Eventea=g,r}(),E={},_={},P={},M={};function R(){return w||(w=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.requestWithRetry=e.handleRetryOptions=void 0;const t=async e=>{const{timeout:t=0,url:n}=e,r=new AbortController,s=((e,t)=>setTimeout((()=>e.abort()),t))(r,t),o=await fetch(n,{...e,signal:r.signal});return clearTimeout(s),o};e.handleRetryOptions=e=>{const t={timeout:null==e?void 0:e.timeout,retry:null==e?void 0:e.retry,retryTimeout:null==e?void 0:e.retryTimeout};return t.retry=t.retry?t.retry:t.timeout&&t.retryTimeout?t.timeout/t.retryTimeout:2,t.retryTimeout=t.retryTimeout?t.retryTimeout:t.timeout&&t.retry?t.timeout/t.retry:2500,t.timeout=t.timeout?t.timeout:t.retryTimeout&&t.retry?t.retryTimeout*t.retry:5e3,t};e.requestWithRetry=async(n,r)=>{var s;const{retry:o,retryTimeout:i}=(0,e.handleRetryOptions)(r);let a,l,u;for(const e of function*(){let e=0;for(;o>e;)yield t({url:n,timeout:i}),e+=1}())try{a=await e;break}catch(e){l=e;continue}if(!a)throw l;return(null===(s=a.headers.get("content-type"))||void 0===s?void 0:s.includes("application/json"))?u=await a.json():a&&(u=await a.text()),{status:a.status,body:u}}}(M)),M}var O,D,H,T,C={};function k(){return D||(D=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ClientSingleLoader=e.requestWithRetry=void 0;const t=R(),n=(O||(O=1,Object.defineProperty(C,"__esModule",{value:!0}),C.routingValidator=void 0,C.routingValidator={check:e=>!(!e||"object"!=typeof e||!e.version||!e.events||"v4"!==e.version),getErrors:e=>[`${JSON.stringify(e)}: doesn't match a valid v4 routing schema`]}),C);var r=R();Object.defineProperty(e,"requestWithRetry",{enumerable:!0,get:function(){return r.requestWithRetry}});e.ClientSingleLoader=class{constructor(e){this.currentRequest=null,this.makeRequest=()=>{this.currentRequest=this.request(this.url,{timeout:this.timeout}),this.currentRequest.then((e=>{400>e.status?n.routingValidator.check(e.body)?this.currentRouting=e.body:this.handleRequestError({project:this.project,validationErrors:n.routingValidator.getErrors(e.body)}):this.handleRequestError({project:this.project,status:e.status})}),(e=>{this.handleRequestError({project:this.project,reason:e})})).finally((()=>{this.currentRequest=null}))};const{url:r,baseUrl:s,projectName:o,timeout:i=5e3,fallback:a}=e;if(this.project=o,this.url=r||((e,t)=>{let n=t;return t.endsWith("/")||(n+="/"),`${n}v4/${e}.json`})(o,s),this.handleRequestError=e.handleRequestError,this.timeout=i,this.request=t.requestWithRetry,a){if(!n.routingValidator.check(a)){const t=n.routingValidator.getErrors(e.fallback);throw new Error(`fallback должен быть валидным роутингом:\n${t.join("\n")}`)}this.fallback=a}}handleRequest(){this.currentRouting||this.currentRequest||this.makeRequest()}getRouting(){return this.handleRequest(),this.currentRouting?Promise.resolve(this.currentRouting):this.currentRequest?this.currentRequest.then((()=>{const e=this.currentRouting||this.fallback;return e||Promise.reject(void 0)}),(()=>this.fallback?this.fallback:Promise.reject(void 0))):Promise.reject(void 0)}}}(P)),P}var q,I,x,N,L,U=(T||(T=1,q=E,I=e&&e.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),x=e&&e.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||I(t,e,n)},Object.defineProperty(q,"__esModule",{value:!0}),x(function(){if(H)return _;H=1,Object.defineProperty(_,"__esModule",{value:!0}),_.ClientLoader=void 0;const e=k(),t=()=>({});return _.ClientLoader=class{constructor(n){this.projectSingleLoaders={},this.getSingleLoaderInstance=t=>new e.ClientSingleLoader({projectName:"string"==typeof t?t:t.projectName,fallback:"string"==typeof t?void 0:t.fallback,handleRequestError:this.handleRequestError,timeout:this.timeout,baseUrl:this.baseUrl}),this.getPreloadRoutings=()=>{for(const e of this.preloadProjects){const t="string"==typeof e?e:e.projectName;this.projectSingleLoaders[t]=this.getSingleLoaderInstance(e),this.projectSingleLoaders[t].handleRequest()}},this.addNewLoaderInstance=e=>(this.projectSingleLoaders[e]=this.getSingleLoaderInstance(e),this.projectSingleLoaders[e]);const{baseUrl:r,preloadProjects:s,timeout:o,handleRequestError:i}=n;this.preloadProjects=s,this.baseUrl=r,this.timeout=o,this.handleRequestError=i||t,this.getPreloadRoutings()}async getRouting(e){return e in this.projectSingleLoaders?this.projectSingleLoaders[e].getRouting():this.addNewLoaderInstance(e).getRouting()}},_}(),q)),E);var A=(L||(L=1,N=function(e){var t,n=!1;return function(){return n||(t=e.apply(void 0,arguments),n=!0),t}}),N);const z={info:!0,warn:!0,error:!0,debug:!0,trace:!0,fatal:!0};var B={},V={},W=function(){return W=Object.assign||function(e){for(var t,n=1,r=arguments.length;r>n;n++)for(var s in t=arguments[n])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},W.apply(this,arguments)};function F(e){return e.toLowerCase()}var Q=[/([a-z0-9])([A-Z])/g,/([A-Z])([A-Z][a-z])/g],$=/[^A-Z0-9]+/gi;function J(e,t,n){return t instanceof RegExp?e.replace(t,n):t.reduce((function(e,t){return e.replace(t,n)}),e)}function Z(e,t){var n=e.charAt(0),r=e.substr(1).toLowerCase();return 0>=t||"0">n||n>"9"?""+n.toUpperCase()+r:"_"+n+r}function G(e,t){return void 0===t&&(t={}),function(e,t){void 0===t&&(t={});for(var n=t.splitRegexp,r=t.stripRegexp,s=void 0===r?$:r,o=t.transform,i=void 0===o?F:o,a=t.delimiter,l=void 0===a?" ":a,u=J(J(e,void 0===n?Q:n,"$1\0$2"),s,"\0"),c=0,d=u.length;"\0"===u.charAt(c);)c++;for(;"\0"===u.charAt(d-1);)d--;return u.slice(c,d).split("\0").map(i).join(l)}(e,W({delimiter:"",transform:Z},t))}function X(e,t){return 0===t?e.toLowerCase():Z(e,t)}var K,Y,ee=t(Object.freeze({__proto__:null,camelCaseTransform:X,camelCaseTransformMerge:function(e,t){return 0===t?e.toLowerCase():function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}(e)},camelCase:function(e,t){return void 0===t&&(t={}),G(e,W({transform:X},t))}}));function te(){if(K)return V;K=1,Object.defineProperty(V,"__esModule",{value:!0}),V.statistHandlerFactory=void 0;const e=ee;function t(){if("undefined"!=typeof window&&window.tracking&&tracking._prot)return window.tracking}return V.statistHandlerFactory=function({statistClient:n}){return({event:r,payload:s,project:o,config:i,handlersData:a})=>{let l=s||{};if(!function(e){return"object"==typeof e&&null!==e}(i))throw new Error("Unknown config for statist handler");{const u=`eventea.projects.${(0,e.camelCase)(o)}`,c=i.fullName||`events.${i.eventName||r}`,d=t(),h=a&&a.statist?a.statist:void 0;if(h&&h.commonParams&&d){const e={};for(const t of Object.keys(h.commonParams)){const{deprecated:n}=h.commonParams[t];!n&&t in d._prot.dataPool&&(e[t]=d._prot.dataPool[t])}l={...d._prot.collectDataElements(e),...l}}const{remapAsList:p}=i;if(p)for(const e of Object.keys(p))l[e]=p[e].params.map((t=>{var n,r,o;const i=(null===(n=p[e].paramsSource)||void 0===n?void 0:n[t])||"event";return"event"===i&&s&&t in s?String(null!==(r=s[t])&&void 0!==r?r:""):"dataPool"===i&&d&&t in d._prot.dataPool?String(null!==(o=d._prot.collectDataElement(d._prot.dataPool[t]))&&void 0!==o?o:""):""}));n.send(u,c,l)}}},V}var ne=(Y||(Y=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.statistHandlerFactory=void 0;var t=te();Object.defineProperty(e,"statistHandlerFactory",{enumerable:!0,get:function(){return t.statistHandlerFactory}})}(B)),B),re=function(e,t){return(re=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function se(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}re(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var oe=function(){return(oe=Object.assign||function(e){for(var t,n=1,r=arguments.length;r>n;n++)for(var s in t=arguments[n])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)};function ie(e,t,n){if(n||2===arguments.length)for(var r,s=0,o=t.length;o>s;s++)!r&&s in t||(r||(r=Array.prototype.slice.call(t,0,s)),r[s]=t[s]);return e.concat(r||t)}function ae(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}var le="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0,ue=le.document,ce=le.window,de=le.navigator,he=le.XMLHttpRequest,pe=function(e){return"function"==typeof e?e():e},ve=function(){var e=0;return function(){return{clientEventTimestamp:Date.now(),clientUploadTimestamp:Date.now(),sequence:++e,uuid:ae()}}},fe={test:"https://api-dev-statist.tcsbank.ru",prod:"https://api-statist.tinkoff.ru"},ge=function(){function e(){this.listeners=Object.create(null)}return e.prototype.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.off=function(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((function(e){return e!==t})))},e.prototype.emit=function(e){for(var t=[],n=1;arguments.length>n;n++)t[n-1]=arguments[n];var r=this.listeners[e];if(r)for(var s=0,o=r;o.length>s;s++){var i=o[s];i.apply(void 0,t)}},e}(),ye=function(e){try{return ce.localStorage.getItem(e)}catch(e){return null}},me=function(){var e=ye("__statist_saved_messages");if(null===e)return[];try{return JSON.parse(e)}catch(e){return[]}},be=function(){return function(e){try{return ce.localStorage.removeItem("__statist_saved_messages"),!0}catch(e){return!1}}()},Se=function(){function e(e,t){var n,r=this;this.timer=null,this.eventEmitter=new ge,this.retryDelay=3e3,this.destroy=function(){ce.removeEventListener("visibilitychange",r.handleVisibilityChange),ce.removeEventListener("pagehide",r.handlePageHide)},this.handleVisibilityChange=function(){"hidden"===ue.visibilityState?r.saveMessages():r.processSavedMessages()},this.handlePageHide=function(){r.saveMessages()},this.pushEventsUrl=e+"/gateway/v1/events",this.batchSize=t.batchSize,this.pushInterval=t.pushInterval,this.pushTimeout=null!==(n=t.pushTimeout)&&void 0!==n?n:t.pushInterval,this.savedMessagesSize=t.savedMessagesSize,this.gzipDisabled=!t.gzip||"true"===ye("_statist_disable_gzip"),"visibilityState"in ue?ce.addEventListener("visibilitychange",this.handleVisibilityChange,!1):ce.addEventListener("pagehide",this.handlePageHide,!1),this.events=me(),this.sequence=this.getMaxSequence(this.events),this.events.length>0&&(be(),this.startPush())}return e.createInstance=function(t,n){return void 0===le._statistTransport&&(le._statistTransport=new e(t,n)),le._statistTransport},e.prototype.handleApiError=function(e){var t,n,r,s=this;if(200>e.status||e.status>=500)return(t=this.events).unshift.apply(t,e.events),void this.startPush(this.retryDelay);if(e.response)try{var o=JSON.parse(e.response);if(o.message&&(null===(n=o.details)||void 0===n?void 0:n.errors))return void o.details.errors.forEach((function(t){t&&s.eventEmitter.emit("error",Object.assign(new Error(o.message),{status:e.status,response:t}))}))}catch(e){}this.eventEmitter.emit("error",Object.assign(new Error(null!==(r=e.response)&&void 0!==r?r:e.message),{status:e.status}))},e.prototype.increaseRetryDelay=function(){this.retryDelay=Math.min(6e5,2*this.retryDelay)},e.prototype.resetRetryDelay=function(){this.retryDelay=3e3},e.prototype.saveMessages=function(){if(0!==this.events.length){var e=ie(ie([],me()),this.events);if(e.length>this.savedMessagesSize)e.splice(0,e.length-this.savedMessagesSize);(function(e){try{return function(e,t){try{return ce.localStorage.setItem("__statist_saved_messages",t),!0}catch(e){return!1}}(0,JSON.stringify(e))}catch(e){return!1}})(e)&&(this.events=[])}},e.prototype.processSavedMessages=function(){this.events=me(),this.events.length>0&&(be(),this.sequence=this.getMaxSequence(this.events),this.startPush())},e.prototype.on=function(e,t){this.eventEmitter.on(e,t)},e.prototype.off=function(e,t){this.eventEmitter.off(e,t)},e.prototype.startPush=function(e){var t=this;void 0===e&&(e=this.pushInterval),this.timer||0===this.events.length||(this.timer=setTimeout((function(){return(t.isReady()?t.pushEvents(t.batchSize):Promise.resolve()).then((function(){t.resetRetryDelay(),t.timer=null,t.startPush()}),(function(e){t.timer=null,t.handleApiError(e),t.increaseRetryDelay()}))}),e))},e.prototype.pushEvents=function(e){var t=this.events.splice(0,e);return this.sendByXhr(t)},e.prototype.updateTimestamp=function(e){for(var t=Date.now(),n=0,r=e;r.length>n;n++)r[n].eventParameters.clientUploadTimestamp=t},e.prototype.updateSequence=function(e){e.eventParameters.sequence=++this.sequence},e.prototype.getMaxSequence=function(e){var t=0;return e.forEach((function(e){var n=e.eventParameters.sequence;n>t&&(t=n)})),t},e.prototype.sendByXhr=function(e){var t=this;return he?e.length?(this.updateTimestamp(e),new Promise((function(n,r){var s=new he,o=function(){if(s.status<200||204<s.status){var t=Object.assign(new Error(s.responseText),{status:s.status,response:s.responseText,events:e});r(t)}else n()};s.onerror=o,s.onload=o,s.timeout=t.pushTimeout;var i=JSON.stringify(e);t.gzipDisabled?t.sendEventsJSON(i,s):t.sendEventsGZip(i,s)}))):Promise.resolve():Promise.reject()},e.prototype.sendEventsJSON=function(e,t){t.open("POST",this.pushEventsUrl,!0),t.setRequestHeader("Content-Type","application/json;charset=UTF-8"),t.send(e)},e.prototype.sendEventsGZip=function(e,t){var n=this;(function(e){return function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{l(r.next(e))}catch(e){o(e)}}function a(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((r=r.apply(e,t||[])).next())}))}(void 0,void 0,void 0,(function(){return function(e,t){var n,r,s,o,i={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(s=2&o[0]?r.return:o[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,o[1])).done)return s;switch(r=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!((s=(s=i.trys).length>0&&s[s.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&s[3]>o[1])){i.label=o[1];break}if(6===o[0]&&s[1]>i.label){i.label=s[1],s=o;break}if(s&&s[2]>i.label){i.label=s[2],i.ops.push(o);break}s[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}(this,(function(t){return[2,Promise.resolve().then((function(){return new Blob([e],{type:"application/json"}).stream().pipeThrough(new ce.CompressionStream("gzip"))})).then((function(e){return new Response(e)})).then((function(e){return e.blob()}))]}))}))})(e).then((function(e){try{t.open("POST",n.pushEventsUrl,!0),t.setRequestHeader("Content-Type","application/gzip"),t.setRequestHeader("Content-Encoding","gzip"),t.send(e)}catch(e){}})).catch((function(){n.sendEventsJSON(e,t)}))},e.prototype.sendByBeacon=function(){var e=this.events;this.events=[],e.length&&(this.updateTimestamp(e),de.sendBeacon(this.pushEventsUrl,JSON.stringify(e)))},e.prototype.forceSend=function(){this.sendByBeacon()},e.prototype.send=function(e){this.updateSequence(e),this.events.push(e),this.startPush()},e.prototype.isReady=function(){return!0},e}(),we=function(e,t,n){var r=null!=n?n:new Date(Date.now()+15768e7).toUTCString();return ue.cookie=e+"="+encodeURIComponent(t)+"; expires="+r+"; path=/; domain="+ce.location.hostname.split(".").slice(-2).join("."),t},je=function(e){return ue.cookie.split("; ").reduce((function(t,n){var r=n.split("=");return r[0]===e?decodeURIComponent(r[1]):t}),"")||null},Ee=function(e){null!==je(e)&&we(e,"",new Date(0).toUTCString())},_e=function(){function e(e,t,n,r){void 0===r&&(r=18e5),this.clientParameters=e,this.transport=t,this.eventParameters=n,this.sessionTimeout=r,this.deviceId=je("stDeIdU")||we("stDeIdU",ae()),this.screenWidth=ce.screen.width,this.screenHeight=ce.screen.height,this.codegenVersion="",this.eventEmitter=new ge}return e.prototype.getSessionId=function(){var e=je("vIdUid"),t=Number(je("stLaEvTi"))||null;if(null!==e&&null!==t&&Date.now()-t<this.sessionTimeout)return e;var n=we("vIdUid",ae());return Ee("stLaEvTi"),Ee("stSeStTi"),n},e.prototype.getSessionStartTime=function(){return null===je("stSeStTi")?Date.now():Number(je("stSeStTi"))},e.prototype.resolveClientParameters=function(e){return oe(oe({},null!=e?e:this.clientParameters),{sessionId:this.getSessionId(),deviceId:this.deviceId,sessionStartTime:this.getSessionStartTime(),screenWidth:this.screenWidth,screenHeight:this.screenHeight,sdkVersion:"0.4.46",codegenVersion:this.codegenVersion})},e.prototype.transportSend=function(e){this.transport.send(e),we("stLaEvTi",Date.now()),null===je("stSeStTi")&&we("stSeStTi",e.clientParameters.sessionStartTime)},e.prototype.sendUserProperties=function(e,t,n,r){var s,o,i=((s={kind:"userProperties",project:e,eventParameters:pe(this.eventParameters),clientParameters:this.resolveClientParameters()})[n]=((o={})["$"+t]=r,o),s);this.transportSend(i),this.eventEmitter.emit("message",{type:"userProperties",message:i})},e.prototype.send=function(e,t,n,r){var s={project:e,name:t,parameters:n,eventParameters:pe(this.eventParameters),clientParameters:this.resolveClientParameters(r)};this.transportSend(s),this.eventEmitter.emit("message",{type:"event",message:s})},e.prototype.updateClientParameters=function(e){for(var t in e)this.clientParameters[t]=e[t]},e.prototype.updateUserProperties=function(e,t,n){this.sendUserProperties(e,t,"userProperties",null!=n?n:{})},e.prototype.updateFeatureFlags=function(e,t){this.sendUserProperties(e,"set","featureFlags",null!=t?t:{})},e.prototype.updateABGroups=function(e,t){this.sendUserProperties(e,"set","ABGroups",null!=t?t:{})},e.prototype.on=function(e,t){"message"===e?this.eventEmitter.on(e,t):this.transport.on(e,t)},e.prototype.off=function(e,t){"message"===e?this.eventEmitter.off(e,t):this.transport.off(e,t)},e.prototype.forceSend=function(){var e,t;null===(t=(e=this.transport).forceSend)||void 0===t||t.call(e)},e.prototype._setCodegenVersion=function(e){this.codegenVersion=e},e}(),Pe=function(e){function t(t){var n=t.transportOptions||{},r=n.batchSize,s=n.pushInterval,o=n.pushTimeout,i=n.savedMessagesSize,a=n.gzip;return e.call(this,t.clientParameters,Se.createInstance(fe[t.environment],{batchSize:void 0===r?500:r,pushInterval:void 0===s?15e3:s,pushTimeout:void 0===o?3e4:o,preconnect:!1,savedMessagesSize:void 0===i?1e3:i,gzip:void 0===a||a}),t.eventParameters||ve(),t.sessionTimeout)||this}return se(t,e),t.prototype.send=function(t,n,r,s){return e.prototype.send.call(this,t,n,r||{},s)},t}(_e);!function(e){function t(t){var n=t.transportOptions||{},r=n.batchSize,s=n.pushInterval,o=n.pushTimeout,i=n.savedMessagesSize,a=n.gzip;return e.call(this,t.clientParameters,Se.createInstance(fe[t.environment],{batchSize:void 0===r?500:r,pushInterval:void 0===s?15e3:s,pushTimeout:void 0===o?3e4:o,preconnect:!1,savedMessagesSize:void 0===i?1e3:i,gzip:void 0===a||a}),t.eventParameters||ve(),t.sessionTimeout)||this}se(t,e),t.prototype.send=function(t,n,r,s){return e.prototype.send.call(this,t,n,r,s)}}(_e);const Me="client-only-eventea",Re="1.0.0";var Oe,De={};var He=(Oe||(Oe=1,Object.defineProperty(De,"__esModule",{value:!0}),De.getTracking=void 0,De.getTracking=function(){if("undefined"==typeof window)throw new Error("EClientOnly");return new Promise((function(e){var t=window.tracking;t&&t.fullfill?t.trackingReady?t.trackingReady().then(e):e(t):window.addEventListener("tracking-created",(function(t){t instanceof CustomEvent&&e(t.detail||window.tracking)}))}))}),De);const Te=({logger:e,eventProps:t,appName:n})=>{var r;const{event:s,project:o,payload:i,eventRouting:a}=t,{routes:{logs:l}}=a,u=null==l?void 0:l.level,c=null!==(r=null==l?void 0:l.samplingRate)&&void 0!==r?r:1;if(u){if(z[u]&&u in e)return void((0===(d=c)||1===d?d:Math.random()<=d)&&e[u]({event:s,eventeaProject:o,payload:i,appName:n,from:"browser",userAgent:window.navigator.userAgent,href:window.location.href}));e.error({event:"eventea-wrong-logs-config",originalEvent:s,originalLevel:u})}var d},Ce=(e,t,n)=>{try{return JSON.stringify(e,t,n)}catch(r){return((e,t,n)=>{const r=new Set,s=t||(e=>e);return JSON.stringify(e,((e,t)=>t&&"object"==typeof t?r.has(t)?"[~Circular~]":(r.add(t),s(t)):s(t)),n)})(e,t,n)}};var ke,qe,Ie,xe,Ne,Le,Ue,Ae,ze,Be;function Ve(){return qe||(qe=1,ke=function(e,t){return function n(){for(var r=arguments.length,s=new Array(r),o=0;r>o;o++)s[o]=arguments[o];return e>s.length?function(){for(var e=arguments.length,t=new Array(e),r=0;e>r;r++)t[r]=arguments[r];return n.apply(this,s.concat(t))}:t.apply(this,s)}}),ke}!function(){if(xe)return Ie;xe=1;var e=Ve();Ie=e(3,(function(e,t,n){void 0===n&&(n=[]);for(var r=n.length,s=0;r>s;s++)t=e(t,n[s],s,n);return t}))}();var We=function(){if(Be)return ze;Be=1;var e=function(){if(Le)return Ne;Le=1;var e=/([a-z])([A-Z])/g,t=/[^a-zA-Z]+/g;return Ne=function(n){return n.replace(e,(function(e,t,n){return t+" "+n})).split(t)}}(),t=Ae?Ue:(Ae=1,Ue=function(e){return""+e.charAt(0).toUpperCase()+e.slice(1)});return ze=function(n){return e(n).map((function(e,n){return 0===n?e.toLowerCase():t(e.toLowerCase())})).join("")}}();const Fe=(e,t)=>t instanceof Error?Object.assign({message:t.message,stack:t.stack},t):t;class Qe{constructor(e,t="all"){this.log=(e,t)=>{window.logger[this.loggerStorageName][e](Object.assign(Object.assign({},t),{name:this.loggerName}))},this.info=e=>this.log("info",e),this.warn=e=>this.log("warn",e),this.error=e=>this.log("error",e),this.fatal=e=>this.log("fatal",e),this.trace=e=>this.log("trace",e),this.debug=e=>this.log("dedug",e),this.loggerName=t,this.loggerStorageName=We(t),window.logger||(window.logger={}),window.logger[this.loggerStorageName]=e}}const $e=A((()=>{var e;let t;if(document.currentScript){t=new URL((null===(e=document.currentScript)||void 0===e?void 0:e.getAttribute("src"))||"").searchParams}return t})),Je=()=>{const e=$e();let t="unknown";if(e)for(const[n,r]of e)if("appName"===n){t=r;break}return t},Ze=(()=>{const e=Object.create(null);return{useEvent:({project:t,event:n})=>{e[t]||(e[t]=Object.create(null)),e[t][n]=!0},getUsedEvents:()=>Object.keys(e).map((t=>({projectName:t,eventList:Object.keys(e[t])})))}})();window.addEventListener("beforeunload",(()=>{const e=Ze.getUsedEvents();e.length&&e.forEach((({projectName:e,eventList:t})=>{rt.sendOnce({project:"eventea",event:"usage-stats",payload:{projectName:e,eventList:t}},e)}))}));const Ge=(()=>{const e=new Set,t=$e();if(t)for(const[n,r]of t)"project"===n&&e.add(r);return[...e]})(),Xe=new U.ClientLoader({preloadProjects:Ge,baseUrl:"https://acdn.tinkoff.ru/eventea/"}),Ke=new class{constructor(e){this.sendLog=({logApi:e,payload:t})=>fetch(`${e}collect`,{method:"POST",keepalive:!0,headers:{"Content-type":"application/json"},body:Ce(t,Fe)}).catch((e=>e)),this.send=e=>{this.sendLog({logApi:this.apiURL,payload:e})},this.log=(e,t)=>{this.send(Object.assign(Object.assign({},t),{level:e}))},this.error=e=>this.log("error",e),this.info=e=>this.log("info",e),this.warn=e=>this.log("warn",e),this.fatal=e=>this.log("fatal",e),this.debug=e=>this.log("debug",e),this.trace=e=>this.log("trace",e),this.apiURL=e}}("https://www.tinkoff.ru/api/front/log/"),Ye=new Qe(Ke,"eventea-logger-tracking"),et=new Qe(Ke,"eventea-error-handlers"),tt=new Qe(Ke,"eventea-logger"),nt={projectConfigurationMap:{},errorHandlers:(({logger:e})=>({handleMissedEvent:({event:t,project:n})=>{e.error({event:"eventea-missed-event",project:n,eventName:t})},handleMissedEventHandler:({event:t,routeHandlerName:n,project:r})=>{e.error({event:"eventea-missed-event-handler",eventName:t,project:r,routeHandlerName:n})},handleMissedProject:({event:t,project:n})=>{e.error({event:"eventea-missed-project",project:n,eventName:t})},handleMissedRouting:({project:t})=>{e.error({event:"eventea-missed-routing",project:t})},handleMissedDataHandler:({project:t,handlerName:n})=>{e.error({event:"eventea-missed-data-handler",project:t,handlerName:n})},handleMissedDataProject:({project:t})=>{e.error({event:"eventea-missed-data-project",project:t})},handleMissedRoutes:({project:t,event:n})=>{e.error({event:"eventea-missed-routes",project:t,eventName:n})},handleDeprecatedEvent:({project:t,event:n})=>{e.info({event:"eventea-deprecated-event",project:t,eventName:n})},handleEventHandlerError:(t,n,{project:r,event:s})=>{e.error({event:"eventea-handler-error",project:r,eventName:s,handlerName:n,error:t})}}))({logger:et}),routingClientLoader:Xe,beerBaseUrl:"https://www.tinkoff.ru/api/front/eventea-beer/",handleAnyEvent:e=>{Ze.useEvent(e),Te({logger:tt,eventProps:e,appName:Je()})},defaultEventHandlers:{statist:function(e={}){const{client:t=Me,clientVersion:n=Re}=e;return ne.statistHandlerFactory({statistClient:new Pe({environment:"prod",clientParameters:{client:t,clientVersion:n,ssoId:null}})})}((()=>{const e=$e(),t={},n=null==e?void 0:e.get("statist-client");n&&(t.client=n);const r=null==e?void 0:e.get("statist-client-version");return r&&(t.clientVersion=r),t})()),tracking:(({logger:e})=>{const t=A((()=>((e=6e3)=>Promise.race([He.getTracking(),new Promise(((t,n)=>setTimeout((()=>n(new Error(`No tracking after ${e}ms timeout`))),e)))]))().then((e=>e.callUtil("makeEventeaHandler"))).catch((t=>(e.error({event:"Unable to resolve makeEventeaHandler.",error:t}),null)))));return e=>{t().then((t=>{null==t||t(e)}))}})({logger:Ye})}},rt=new j.Eventea(nt);"undefined"!=typeof window&&(window.eventea=rt,window.__eventea=rt)}();
